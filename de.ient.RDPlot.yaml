app-id: de.ient.RDPlot
runtime: org.kde.Platform
runtime-version: '5.10'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.gfortran-62
command: rdplot
finish-args:
  - --socket=wayland
  - --socket=x11
  - --share=ipc
build-options:
  append-path: "/usr/lib/sdk/gfortran-62/bin"
modules:
  - name: gfortran
    buildsystem: simple
    build-commands:
    - "/usr/lib/sdk/gfortran-62/install.sh"

  - name: lapack
    buildsystem: cmake
    builddir: true
    config-opts:
    - "-DCMAKE_BUILD_TYPE=Release"
    - "-DBUILD_SHARED_LIBS=ON"
    - "-DBUILD_TESTING=OFF"
    - "-DCMAKE_Fortran_COMPILER=/usr/lib/sdk/gfortran-62/bin/gfortran"
    - "-DLAPACKE=ON"
    - "-DCBLAS=ON"
    sources:
    - type: archive
      url: http://www.netlib.org/lapack/lapack-3.8.0.tar.gz
      sha512: 17786cb7306fccdc9b4a242de7f64fc261ebe6a10b6ec55f519deb4cb673cb137e8742aa5698fd2dc52f1cd56d3bd116af3f593a01dcf6770c4dcc86c50b2a7f
    cleanup:
    - "/lib/cmake"
  - name: python3-numpy
    buildsystem: simple
    build-commands:
    - python3 setup.py build -j 0
    - python3 setup.py install --prefix=/app --root=/ --optimize=1
    build-options:
      env:
        ATLAS: None
        BLAS: "/app/lib"
        LAPACK: "/app/lib"
    cleanup:
    - "/bin"
    sources:
    - type: archive
      url: https://pypi.python.org/packages/0b/66/86185402ee2d55865c675c06a5cfef742e39f4635a4ce1b1aefd20711c13/numpy-1.14.2.zip
      sha256: facc6f925c3099ac01a1f03758100772560a0b020fb9d70f210404be08006bcb
  - name: python3-scipy
    buildsystem: simple
    build-commands:
    - python3 setup.py build -j 0
    - python3 setup.py install --prefix=/app --root=/ --optimize=1
    build-options:
      env:
        ATLAS: None
        BLAS: "/app/lib"
        LAPACK: "/app/lib"
        LDFLAGS: "-shared"
    sources:
    - type: archive
      url: https://pypi.python.org/packages/bd/f4/3882758754dc083fea6ea66a6e8ceef55e7df173d06a12a074612958800f/scipy-1.0.1.tar.gz
      sha256: 8739c67842ed9a1c34c62d6cca6301d0ade40d50ef14ba292bd331f0d6c940ba

  # sadly this does not work
  # - name: PyQt5
  #   cleanup:
  #   - "/bin/sip"
  #   - "/include"
  #   - "/lib/python3.5/site-packages/*.pyi"
  #   config-opts:
  #   - "--disable-static"
  #   - "--enable-x11"
  #   buildsystem: simple
  #   build-commands:
  #   - python3 configure.py --confirm-license --no-docstrings --assume-shared --no-sip-files
  #     --no-qml-plugin --no-tools --no-qsci-api -d ${FLATPAK_DEST}/lib/python3.5/site-packages
  #     --sip=${FLATPAK_DEST}/bin/sip --sip-incdir=${FLATPAK_DEST}/include --stubsdir=${FLATPAK_DEST}/lib/python3.5/site-packages
  #     --disable=QtSensors --disable=QtWebEngine --disable=QtQuick --disable=QtQml --disable=QtTest
  #     --disable=QtWebChannel --disable=QtWebEngineCore --disable=QWebEngineWidgets --disable=QtQuickWidgets
  #     --disable=QtSql --disable=QtXmlPatterns --disable=QtMultimedia --disable=QtMultimediaWidgets
  #     --disable=QtLocation --disable=QtDesigner --disable=QtOpenGL --disable=QtBluetooth
  #     --disable=QtWebKit --disable=QtWebKitWidgets --disable=QtNfc --disable=QtPositioning
  #   - make -j $(nproc)
  #   - make install
  #   sources:
  #   - type: archive
  #     url: https://sourceforge.net/projects/pyqt/files/PyQt5/PyQt-5.10.1/PyQt5_gpl-5.10.1.tar.gz
  #     sha256: 9932e971e825ece4ea08f84ad95017837fa8f3f29c6b0496985fa1093661e9ef
  #   modules:
  #   - name: sip
  #     buildsystem: simple
  #     build-commands:
  #     - python3 configure.py -b ${FLATPAK_DEST}/bin -d ${FLATPAK_DEST}/lib/python3.5/site-packages
  #       -e ${FLATPAK_DEST}/include -v ${FLATPAK_DEST}/share/sip --stubsdir=${FLATPAK_DEST}/lib/python3.5/site-packages
  #     - make
  #     - make install
  #     sources:
  #     - type: archive
  #       url: https://sourceforge.net/projects/pyqt/files/sip/sip-4.19.8/sip-4.19.8.tar.gz
  #       sha256: 7eaf7a2ea7d4d38a56dd6d2506574464bddf7cf284c960801679942377c297bc
  


  - name: sip # for pyqt
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app sip-4.19.8-cp35-cp35m-manylinux1_x86_64.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/6b/46/2869369c8ec634ec9dc714b84834e9264acbe87eb7492328efccfa0c855e/sip-4.19.8-cp35-cp35m-manylinux1_x86_64.whl
        sha256: e72955e12f4fccf27aa421be383453d697b8a44bde2cc26b08d876fd492d0174

  - name: PyQt5-wheel
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app PyQt5-5.10.1-5.10.1-cp35.cp36.cp37.cp38-abi3-manylinux1_x86_64.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/e4/15/4e2e49f64884edbab6f833c6fd3add24d7938f2429aec1f2883e645d4d8f/PyQt5-5.10.1-5.10.1-cp35.cp36.cp37.cp38-abi3-manylinux1_x86_64.whl
        sha256: 1e652910bd1ffd23a3a48c510ecad23a57a853ed26b782cd54b16658e6f271ac


  - python3-setuptools-scm.json
  - python3-GitPython.json
  - python3-cycler.json
  - python3-matplotlib.json
  - python3-matplotlib2tikz.json
  - python3-py.json
  - python3-tabulate.json
  - python3-scandir.json
  - python3-pathlib2.json
  - python3-pytest.json
  - python3-mpldatacursor.json
  - python3-xmltodict.json
  - python3-jsonpickle.json

  - name: RDPlot
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/IENT/RDPlot.git
        commit: 3c8a530e2c2c5d1119b1374015b0f8cfe2879127
      - type: file
        path: de.ient.RDPlot.desktop
      - type: file
        path: de.ient.RDPlot.appdata.xml
    build-commands:
      - echo "v1.2.0-3-gbe9a987"  > version.txt # workaround for letting setup.py know version
      - FLATPAK_INSTALL=1 python3 setup.py install --install-scripts=/bin  --root=/app --install-lib=/lib/python3.5/site-packages/ 
      - install -Dm644 src/rdplot/logo/PLOT16.png     /app/share/icons/hicolor/16x16/apps/de.ient.RDPlot.png
      - install -Dm644 src/rdplot/logo/PLOT32.png     /app/share/icons/hicolor/32x32/apps/de.ient.RDPlot.png
      - install -Dm644 src/rdplot/logo/PLOT64.png     /app/share/icons/hicolor/64x64/apps/de.ient.RDPlot.png
      - install -Dm644 src/rdplot/logo/PLOT128.png    /app/share/icons/hicolor/128x128/apps/de.ient.RDPlot.png
      - install -Dm644 src/rdplot/logo/PLOT256.png    /app/share/icons/hicolor/256x256/apps/de.ient.RDPlot.png
      - install -Dm644 src/rdplot/logo/PLOT512.png    /app/share/icons/hicolor/512x512/apps/de.ient.RDPlot.png
      - install -Dm644 src/rdplot/logo/PLOT1024.png   /app/share/icons/hicolor/1024x1024/apps/de.ient.RDPlot.png
      - install -Dm644 de.ient.RDPlot.desktop         /app/share/applications/de.ient.RDPlot.desktop
      - install -Dm644 de.ient.RDPlot.appdata.xml     /app/share/metainfo/de.ient.RDPlot.appdata.xml
